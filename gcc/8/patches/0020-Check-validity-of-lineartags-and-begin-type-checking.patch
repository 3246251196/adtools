From 958adf54a6220a6018e24c62d6dd235d3c8ce25f Mon Sep 17 00:00:00 2001
From: Sebastian Bauer <mail@sebastianbauer.info>
Date: Thu, 26 Apr 2018 20:49:02 +0200
Subject: [PATCH 20/20] Check validity of lineartags and begin type checking
 also for int params.

---
 gcc/c/c-typeck.c            |  6 ++++--
 gcc/config/rs6000/amigaos.c | 30 ++++++++++++++++++++++++++++--
 2 files changed, 32 insertions(+), 4 deletions(-)

diff --git a/gcc/c/c-typeck.c b/gcc/c/c-typeck.c
index 0d6fa12c64dd31d00ce4a693f528d585ea532056..ee96f8c75a6be19169d22327ef8c384dad59406d 100644
--- a/gcc/c/c-typeck.c
+++ b/gcc/c/c-typeck.c
@@ -3362,15 +3362,17 @@ convert_arguments (location_t loc, vec<location_t> arg_loc, tree typelist,
 		promote_float_arg = false;
 		break;
 	      }
 	}
 
       /* If this is a function call with linear tags try to improve the expected
-       * type on base of recorded tag <-> type mapping.
+       * type on base of recorded tag <-> type mapping, but only if we don't know
+       * the expected type (e.g. on a var) or if the expected type is an integer.
+       * The latter case usually happens on the first tag item.
        */
-      if (lineartags && type == NULL_TREE)
+      if (lineartags && (type == NULL_TREE || TREE_CODE(type) == INTEGER_TYPE))
         {
           extern tree amigaos_get_type_associated_tagtype(tree type);
 
           if (prev_tagtype)
             {
               type = prev_tagtype;
diff --git a/gcc/config/rs6000/amigaos.c b/gcc/config/rs6000/amigaos.c
index 2cabd894b0337a4f5119192d41dcbf42386d287c..db803847e90047b90c8c88e3aa9b50c8ccf73489 100644
--- a/gcc/config/rs6000/amigaos.c
+++ b/gcc/config/rs6000/amigaos.c
@@ -346,16 +346,42 @@ amigaos_handle_linearvarargs_attribute (tree *node, tree name,
       *no_add_attrs = true;
     }
 
   return NULL_TREE;
 }
 
+/* Handle a lineartags attribute. This enables tag verifications */
 tree
-amigaos_handle_lineartags_attribute (tree *node, tree name, tree args, int flags, bool *no_add_attrs)
+amigaos_handle_lineartags_attribute (tree *node, tree name, tree args, int flags ATTRIBUTE_UNUSED, bool *no_add_attrs)
 {
-  /* TODO: This function should applied only to functions or methods */
+  if (TREE_CODE (*node) != FUNCTION_TYPE)
+    {
+      warning (0, "%s attribute only applies to functions",
+	       IDENTIFIER_POINTER (name));
+      *no_add_attrs = true;
+    }
+  tree fn = *node;
+  tree arglist = TYPE_ARG_TYPES(fn);
+  int arg = 0;
+  bool is_varargs = true;
+
+  while (arglist != NULL_TREE)
+    {
+      /* The void_type marks the end of a non-varargs function */
+      if (TREE_VALUE(arglist) == void_type_node)
+        is_varargs = false;
+
+      arglist = TREE_CHAIN (arglist);
+      arg++;
+    }
+
+  if (!is_varargs && arg == 2)
+    {
+      warning (0, "%s attribute only applies to varargs functions or functions with at least two arguments",
+	       IDENTIFIER_POINTER (name));
+    }
   return NULL_TREE;
 }
 
 
 /* Generate code for base relative access */
 
-- 
2.14.2

